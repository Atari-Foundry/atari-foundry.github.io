{"pageProps":{"product":"crucible","productDocs":{"product":"crucible","files":[{"path":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/README.md","relativePath":"README.md","relativeDir":"","filename":"README","slug":"readme","name":"README"},{"path":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/API_REFERENCE.md","relativePath":"API_REFERENCE.md","relativeDir":"","filename":"API_REFERENCE","slug":"api-reference","name":"API REFERENCE"},{"path":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/ARCHITECTURE.md","relativePath":"ARCHITECTURE.md","relativeDir":"","filename":"ARCHITECTURE","slug":"architecture","name":"ARCHITECTURE"},{"path":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/ATTRIBUTIONS.md","relativePath":"ATTRIBUTIONS.md","relativeDir":"","filename":"ATTRIBUTIONS","slug":"attributions","name":"ATTRIBUTIONS"},{"path":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/BUILDING.md","relativePath":"BUILDING.md","relativeDir":"","filename":"BUILDING","slug":"building","name":"BUILDING"},{"path":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/CHANGELOG.md","relativePath":"CHANGELOG.md","relativeDir":"","filename":"CHANGELOG","slug":"changelog","name":"CHANGELOG"},{"path":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/USER_GUIDE.md","relativePath":"USER_GUIDE.md","relativeDir":"","filename":"USER_GUIDE","slug":"user-guide","name":"USER GUIDE"}],"navTree":{"_files":[{"name":"README","slug":"readme","path":"README.md","fullPath":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/README.md","isIndex":true},{"name":"API REFERENCE","slug":"api-reference","path":"API_REFERENCE.md","fullPath":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/API_REFERENCE.md","isIndex":false},{"name":"ARCHITECTURE","slug":"architecture","path":"ARCHITECTURE.md","fullPath":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/ARCHITECTURE.md","isIndex":false},{"name":"ATTRIBUTIONS","slug":"attributions","path":"ATTRIBUTIONS.md","fullPath":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/ATTRIBUTIONS.md","isIndex":false},{"name":"BUILDING","slug":"building","path":"BUILDING.md","fullPath":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/BUILDING.md","isIndex":false},{"name":"CHANGELOG","slug":"changelog","path":"CHANGELOG.md","fullPath":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/CHANGELOG.md","isIndex":false},{"name":"USER GUIDE","slug":"user-guide","path":"USER_GUIDE.md","fullPath":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/USER_GUIDE.md","isIndex":false}]}},"docFile":{"path":"/home/megalith/AtariProjects/AtariFoundry/www/PROJECT_DOCS/crucible/ARCHITECTURE.md","relativePath":"ARCHITECTURE.md","relativeDir":"","filename":"ARCHITECTURE","slug":"architecture","name":"ARCHITECTURE","content":"# Crucible Architecture Documentation\n\n## Table of Contents\n\n1. [Overview](#overview)\n2. [System Architecture](#system-architecture)\n3. [Core Components](#core-components)\n4. [Memory Map](#memory-map)\n5. [Device Handlers](#device-handlers)\n6. [Filesystem Implementation](#filesystem-implementation)\n7. [Hardware Emulation](#hardware-emulation)\n8. [Callback System](#callback-system)\n9. [Build System](#build-system)\n\n## Overview\n\nCrucible is a 6502 simulator with Atari 8-bit BIOS emulation. It consists of several layers:\n\n1. **CPU Simulator** (`sim65`) - 6502 instruction execution\n2. **BIOS Emulation** (`atari`, `atcio`) - Atari OS calls\n3. **Device Handlers** - CIO device implementations\n4. **Filesystem** - ATR and host filesystem access\n5. **Hardware** - POKEY, GTIA, ANTIC, PIA emulation\n\n## System Architecture\n\n```\n┌─────────────────────────────────────────┐\n│         Application (XEX)               │\n└──────────────┬──────────────────────────┘\n               │\n┌──────────────▼──────────────────────────┐\n│      Atari BIOS Emulation               │\n│  ┌──────────┐  ┌──────────┐            │\n│  │   CIO    │  │   DOS    │            │\n│  └────┬─────┘  └────┬─────┘            │\n└───────┼─────────────┼──────────────────┘\n        │             │\n┌───────▼─────────────▼──────────────────┐\n│      Device Handlers                   │\n│  ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐       │\n│  │ E:│ │ D:│ │ H:│ │ K:│ │ R:│       │\n│  └───┘ └───┘ └───┘ └───┘ └───┘       │\n└───────┬─────────────┬──────────────────┘\n        │             │\n┌───────▼─────────────▼──────────────────┐\n│   Filesystem Layer                     │\n│  ┌──────────┐  ┌──────────┐           │\n│  │   ATR    │  │   Host   │           │\n│  └──────────┘  └──────────┘           │\n└────────────────────────────────────────┘\n        │\n┌───────▼────────────────────────────────┐\n│      6502 CPU Simulator (sim65)        │\n└────────────────────────────────────────┘\n```\n\n## Core Components\n\n### sim65 - CPU Simulator\n\n**Location**: `src/sim65.c`, `src/sim65.h`\n\n**Purpose**: Core 6502 instruction execution engine\n\n**Key Features**:\n- Full 6502 instruction set\n- Memory management with callbacks\n- Cycle counting\n- Profiling support\n- Debug tracing\n\n**Key Functions**:\n- `sim65_new()` - Create simulator instance\n- `sim65_run()` - Execute instructions\n- `sim65_call()` - Call subroutine and return\n- `sim65_add_callback()` - Register memory/execution callbacks\n\n### atari - BIOS Emulation\n\n**Location**: `src/atari.c`, `src/atari.h`\n\n**Purpose**: Atari OS vector and BIOS emulation\n\n**Key Features**:\n- OS vector handling\n- XEX file loading\n- ROM loading\n- Boot from disk image\n- Math pack integration\n\n**Key Functions**:\n- `atari_init()` - Initialize BIOS\n- `atari_xex_load()` - Load XEX file\n- `atari_boot_image()` - Boot from ATR image\n\n### atcio - CIO System\n\n**Location**: `src/atcio.c`, `src/atcio.h`\n\n**Purpose**: Central I/O (CIO) system implementation\n\n**Key Features**:\n- CIOV vector emulation\n- IOCB management\n- Device handler routing\n- Error handling\n\n**Key Functions**:\n- `atari_cio_init()` - Initialize CIO system\n- Device handler registration\n- IOCB parameter handling\n\n## Memory Map\n\n### Standard Atari Memory Layout\n\n```\n$0000 - $00FF   Zero Page\n$0100 - $01FF   Stack\n$0200 - $02FF   OS RAM\n$0300 - $03FF   IOCB and vectors\n$0400 - $07FF   Free RAM\n$0800 - $BFFF   User RAM (default)\n$C000 - $CFFF   Cartridge ROM (optional)\n$D000 - $D7FF   Hardware registers\n$E000 - $FFFF   OS ROM / BIOS\n```\n\n### Hardware Registers\n\n```\n$D000 - $D01F   GTIA\n$D200 - $D20F   POKEY\n$D400 - $D40E   ANTIC\n$D300 - $D3FF   PIA\n```\n\n### OS Vectors\n\n```\n$E456           CIOV (Central I/O Vector)\n$E459           SIOV (Serial I/O Vector)\n$E465           SETVBV (Set VBLANK Vector)\n$E468           SYSVBV (System VBLANK Vector)\n```\n\n## Device Handlers\n\n### E: Device (Editor/Screen)\n\n**Handler**: `sim_SCREN()` in `src/atcio.c`\n\n**Features**:\n- Standard input/output\n- ATASCII translation\n- Screen positioning (PLOT, DRAWTO, FILLTO)\n- Graphics mode support\n\n### D: Device (Disk - ATR)\n\n**Handler**: `sim_DISKD()` in `src/ataridos.c`\n\n**Features**:\n- ATR filesystem access\n- Directory reading\n- File reading\n- Subdirectory navigation\n- File attributes\n\n**Implementation**: Uses `atrfs` module for filesystem operations\n\n### H: Device (Host Filesystem)\n\n**Handler**: `sim_HOST()` in `src/athost.c`\n\n**Features**:\n- Host filesystem access\n- File read/write\n- Directory reading\n- Full CIO compatibility\n\n**Root Path**: Configurable via `-R` option\n\n### K: Device (Keyboard)\n\n**Handler**: `sim_KEYBD()` in `src/atcio.c`\n\n**Features**:\n- Character input\n- ATASCII translation\n- Key code mapping\n\n### R: Device (RS-232)\n\n**Handler**: `sim_RDEV()` in `src/atrdev.c`\n\n**Features**:\n- Serial I/O emulation\n- Baud rate configuration\n- Translation modes\n\n## Filesystem Implementation\n\n### ATR Filesystem (atrfs)\n\n**Location**: `src/atrfs.c`, `src/atrfs.h`\n\n**Purpose**: Read files from ATR disk images\n\n**Key Structures**:\n```c\nstruct atr_file_handle {\n    sim65 s;\n    uint16_t start_sector;\n    uint16_t current_sector;\n    uint32_t file_size;\n    uint32_t position;\n    uint8_t sector_buffer[256];\n    // ...\n};\n\nstruct atr_dir_entry {\n    uint8_t flags;\n    uint16_t start_sector;\n    uint16_t sector_count;\n    uint32_t byte_count;\n    char filename[12];\n    char full_filename[13];\n};\n```\n\n**Key Functions**:\n- `atrfs_find_file()` - Find file in directory\n- `atrfs_open_file()` - Open file handle\n- `atrfs_read_byte()` - Read byte from file\n- `atrfs_read_directory()` - Read directory entries\n\n**Supported Formats**:\n- DOS 2.x\n- SpartaDOS 3.x\n- BW-DOS\n\n**Features**:\n- VTOC reading\n- Sector chain following\n- Subdirectory navigation\n- File attribute parsing\n\n### Host Filesystem (athost)\n\n**Location**: `src/athost.c`, `src/athost.h`\n\n**Purpose**: Access host operating system filesystem\n\n**Features**:\n- Standard file operations\n- Directory reading\n- Path resolution\n- Error handling\n\n## Hardware Emulation\n\n### POKEY\n\n**Location**: `src/hw.c`\n\n**Registers Emulated**:\n- `$D200-$D209` - Audio and keyboard\n- `$D20A-$D20F` - Serial I/O and interrupts\n- `$D20D-$D20F` - Potentiometer inputs\n\n**Features**:\n- Random number generator\n- Serial I/O\n- Interrupt handling\n- Audio registers (stubs)\n- Keyboard scanning\n\n### GTIA\n\n**Location**: `src/hw.c`\n\n**Registers Emulated**:\n- `$D000-$D01F` - All GTIA registers (stubs)\n\n**Features**:\n- CONSOL register (console keys)\n- Player/Missile graphics (stubs)\n- Color registers (stubs)\n- Priority registers (stubs)\n\n### ANTIC\n\n**Location**: `src/hw.c`\n\n**Registers Emulated**:\n- `$D400-$D40E` - All ANTIC registers (stubs)\n\n**Features**:\n- VCOUNT (vertical line counter)\n- DMA control (stubs)\n- Display list (stubs)\n- Scroll registers (stubs)\n\n### PIA\n\n**Location**: `src/hw.c`\n\n**Registers Emulated**:\n- `$D300` - PORTB (memory banking)\n- `$D302` - PORTA (joystick/paddle)\n- `$D303` - PACTL\n- `$D301` - PBCTL\n\n**Features**:\n- Memory banking control\n- Joystick/paddle inputs (stubs)\n- Control register support\n\n## Callback System\n\n### Execution Callbacks\n\nCallbacks are registered at specific addresses and executed when the PC reaches that address.\n\n**Example**:\n```c\nadd_rts_callback(s, CIOV, 1, sim_CIOV);\n```\n\nThis places an RTS instruction at `$E456` and registers `sim_CIOV` as a callback.\n\n### Memory Callbacks\n\n- **Read callbacks**: Executed when memory is read\n- **Write callbacks**: Executed when memory is written\n- **Execution callbacks**: Executed when instruction is fetched\n\n### RTS Simulation\n\nFor callbacks that replace RTS instructions, the callback must simulate the RTS:\n\n```c\n// Pop return address from stack\nregs->s = (regs->s + 1) & 0xFF;\nval = peek(s, 0x100 + regs->s);\nregs->pc = val;\nregs->s = (regs->s + 1) & 0xFF;\nval = peek(s, 0x100 + regs->s);\nregs->pc |= val << 8;\nregs->pc = (regs->pc + 1) & 0xFFFF;\n```\n\n## Build System\n\n### Makefile Structure\n\n**Targets**:\n- `all` - Build project (default)\n- `clean` - Remove build artifacts\n- `help` - Show help\n- `test` - Run tests\n\n**Variables**:\n- `CC` - C compiler (gcc)\n- `CFLAGS` - Compiler flags\n- `LDLIBS` - Linker libraries\n- `BDIR` - Build directory\n- `ODIR` - Object directory\n- `TARGET` - Executable path\n\n### Source Files\n\n**Core**:\n- `sim65.c` - CPU simulator\n- `atari.c` - BIOS emulation\n- `atcio.c` - CIO system\n- `main.c` - Main program\n\n**Devices**:\n- `ataridos.c` - D: device\n- `athost.c` - H: device\n- `atrdev.c` - R: device\n- `atsio.c` - SIO emulation\n\n**Filesystem**:\n- `atrfs.c` - ATR filesystem\n- `dosfname.c` - DOS filename handling\n\n**Hardware**:\n- `hw.c` - Hardware registers\n\n**Math**:\n- `mathpack.c` - Math pack integration\n\n### Dependencies\n\n- Standard C library\n- Math library (`-lm`)\n- No external dependencies\n\n### Compilation\n\n```bash\n# Debug build\nmake CFLAGS=\"-g -O0\"\n\n# Release build\nmake CFLAGS=\"-O3 -flto\"\n\n# Clean and rebuild\nmake clean && make\n```\n\n## Data Flow\n\n### Program Execution\n\n1. Load XEX file → Parse segments → Load into memory\n2. Set RUNAD → Jump to entry point\n3. Execute instructions → Handle callbacks\n4. Return on RTS or error\n\n### CIO Call Flow\n\n1. Program calls CIOV (`JSR $E456`)\n2. Callback `sim_CIOV` executes\n3. Parse IOCB parameters\n4. Route to device handler\n5. Device handler processes request\n6. Return to caller (RTS simulation)\n\n### File Access Flow\n\n**ATR (D:)**:\n1. Parse filename\n2. Search directory via `atrfs_find_file()`\n3. Open file handle via `atrfs_open_file()`\n4. Read sectors via `atrfs_read_byte()`\n5. Follow sector chains\n\n**Host (H:)**:\n1. Parse filename\n2. Resolve path (root + filename)\n3. Open file via `fopen()`\n4. Read/write via standard I/O\n\n## Error Handling\n\n### Error Levels\n\n- `none` - No error reporting\n- `mem` - Memory errors only\n- `full` - All errors (default)\n\n### Error Types\n\n- `sim65_err_exec_undef` - Undefined instruction\n- `sim65_err_exec_uninit` - Uninitialized memory execution\n- `sim65_err_read_uninit` - Uninitialized memory read\n- `sim65_err_write_rom` - Write to ROM\n- `sim65_err_break` - BRK instruction\n- `sim65_err_invalid_ins` - Invalid instruction\n\n## Performance Considerations\n\n### Cycle Counting\n\n- Accurate cycle counting for timing\n- Supports real-time and cycle-based timing\n- Profiling for performance analysis\n\n### Memory Management\n\n- Static memory allocation\n- No dynamic allocation during execution\n- Efficient callback lookup\n\n### Optimization\n\n- Link-time optimization (LTO) enabled\n- Aggressive compiler optimizations\n- Inline functions for hot paths\n\n## See Also\n\n- [User Guide](USER_GUIDE.md) - Usage instructions\n- [API Reference](API_REFERENCE.md) - Developer API\n- [Building Guide](BUILDING.md) - Build details\n"},"currentPath":"architecture"},"__N_SSG":true}